 /*
 * AutoSuggest
 * Copyright 2009-2010 Drew Wilson
 * www.drewwilson.com
 * code.drewwilson.com/entry/autosuggest-jquery-plugin
 *
 * Version 1.4   -   Updated: Mar. 23, 2010
 *
 * This Plug-In will auto-complete or auto-suggest completed search queries
 * for you as you type. You can add multiple selections and remove them on
 * the fly. It supports keybord navigation (UP + DOWN + RETURN), as well
 * as multiple AutoSuggest fields on the same page.
 *
 * Inspied by the Autocomplete plugin by: Jšrn Zaefferer
 * and the Facelist plugin by: Ian Tearle (iantearle.com)
 *
 * This AutoSuggest jQuery plug-in is dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */
(function(c){c.fn.autoSuggest=function(f,C){var a=c.extend({asHtmlID:!1,startText:"Enter Tag Here",emptyText:"No Results Found",preFill:null,limitText:"No More Selections Are Allowed",selectedItemProp:"value",selectedValuesProp:"value",searchObjProps:"value",queryParam:"q",retrieveLimit:!1,extraParams:"",matchCase:!1,minChars:1,keyDelay:400,resultsHighlight:!0,neverSubmit:!1,selectionLimit:!1,showResultList:!0,start:function(){},selectionClick:function(){},selectionAdded:function(){},selectionRemoved:function(a){a.remove()},
formatList:!1,beforeRetrieve:function(a){return a},retrieveComplete:function(a){return a},resultClick:function(){},resultsComplete:function(){}},C),v="object",u=0;if("string"==typeof f)var v="string",D=f;else{var E=f;for(k in f)f.hasOwnProperty(k)&&u++}if("object"==v&&0<u||"string"==v)return this.each(function(b){function f(){if(46==lastKeyPressCode||8<lastKeyPressCode&&32>lastKeyPressCode)return h.hide();var d=g.val().replace(/[\\]+|[\/]+/g,"");if(d!=w)if(w=d,d.length>=a.minChars)if(i.addClass("loading"),
"string"==v){var n="";a.retrieveLimit&&(n="&limit="+encodeURIComponent(a.retrieveLimit));a.beforeRetrieve&&(d=a.beforeRetrieve.call(this,d));c.getJSON(D+"?"+a.queryParam+"="+encodeURIComponent(d)+n+a.extraParams,function(c){u=0;c=a.retrieveComplete.call(this,c);for(k in c)c.hasOwnProperty(k)&&u++;z(c,d)})}else a.beforeRetrieve&&(d=a.beforeRetrieve.call(this,d)),z(E,d);else i.removeClass("loading"),h.hide()}function z(d,n){a.matchCase||(n=n.toLowerCase());var b=0;h.html(s.html("")).hide();for(var e=
0;e<u;e++){var l=e;A++;var f=!1;if("value"==a.searchObjProps)var p=d[l].value;else for(var p="",o=a.searchObjProps.split(","),m=0;m<o.length;m++)var q=c.trim(o[m]),p=p+d[l][q]+" ";p&&(a.matchCase||(p=p.toLowerCase()),-1!=p.search(n)&&-1==j.val().search(","+d[l][a.selectedValuesProp]+",")&&(f=!0));if(f&&(f=c('<li class="as-result-item" id="as-result-item-'+l+'"></li>').click(function(){var d=c(this).data("data"),b=d.num;if(c("#as-selection-"+b,i).length<=0&&!x){var n=d.attributes;g.val("").focus();
w="";y(n,b);a.resultClick.call(this,d);h.hide()}x=false}).mousedown(function(){r=false}).mouseover(function(){c("li",s).removeClass("active");c(this).addClass("active")}).data("data",{attributes:d[l],num:A}),l=c.extend({},d[l]),p=a.matchCase?RegExp("(?![^&;]+;)(?!<[^<>]*)("+n+")(?![^<>]*>)(?![^&;]+;)","g"):RegExp("(?![^&;]+;)(?!<[^<>]*)("+n+")(?![^<>]*>)(?![^&;]+;)","gi"),a.resultsHighlight&&(l[a.selectedItemProp]=l[a.selectedItemProp].replace(p,"<em>$1</em>")),f=a.formatList?a.formatList.call(this,
l,f):f.html(l[a.selectedItemProp]),s.append(f),delete l,b++,a.retrieveLimit&&a.retrieveLimit==b))break}i.removeClass("loading");0>=b&&s.html('<li class="as-message">'+a.emptyText+"</li>");s.css("width",i.outerWidth());h.show();a.resultsComplete.call(this)}function y(d,b){j.val(j.val()+d[a.selectedValuesProp]+",");var f=c('<li class="as-selection-item" id="as-selection-'+b+'"></li>').click(function(){a.selectionClick.call(this,c(this));i.children().removeClass("selected");c(this).addClass("selected")}).mousedown(function(){r=
!1}),h=c('<a class="as-close">&times;</a>').click(function(){j.val(j.val().replace(","+d[a.selectedValuesProp]+",",","));a.selectionRemoved.call(this,f);r=!0;g.focus();return!1});o.before(f.html(d[a.selectedItemProp]).prepend(h));a.selectionAdded.call(this,o.prev())}function B(a){if(0<c(":visible",h).length){var b=c("li",h),f="down"==a?b.eq(0):b.filter(":last"),g=c("li.active:first",h);0<g.length&&(f="down"==a?g.next():g.prev());b.removeClass("active");f.addClass("active")}}b=a.asHtmlID?a.asHtmlID:
b+""+Math.floor(100*Math.random());a.start.call(this);var g=c(this);g.attr("autocomplete","off").addClass("as-input");var r=!1;g.wrap('<ul class="as-selections" id="as-selections-'+b+'"></ul>').wrap('<li class="as-original" id="as-original-'+b+'"></li>');var i=c("#as-selections-"+b),o=c("#as-original-"+b),h=c('<div class="as-results" id="as-results-'+b+'"></div>').hide(),s=c('<ul class="as-list"></ul>'),j=c('<input type="hidden" class="as-values" name="as_values_'+b+'" id="as-values-'+b+'" />');j.attr("name",
g.attr("name"));g.removeAttr("name");null===a.preFill&&(a.preFill=g.val());g.val(a.startText);var e="";if("string"==typeof a.preFill){for(var m=a.preFill.split(","),b=0;b<m.length;b++){var q={};q[a.selectedValuesProp]=m[b];""!=m[b]&&y(q,"000"+b)}e=a.preFill}else{e="";m=0;for(k in a.preFill)a.preFill.hasOwnProperty(k)&&m++;if(0<m)for(b=0;b<m;b++)q=a.preFill[b][a.selectedValuesProp],void 0==q&&(q=""),e=e+q+",",""!=q&&y(a.preFill[b],"000"+b)}""!=e&&(g.val(""),","!=e.substring(e.length-1)&&(e+=","),j.val(","+
e),c("li.as-selection-item",i).addClass("blur").removeClass("selected"));g.after(j);i.click(function(){r=true;g.focus()}).mousedown(function(){r=false}).after(h);var t=null,w="",x=!1;g.focus(function(){if(c(this).val()==a.startText&&j.val()=="")c(this).val("");else if(r){c("li.as-selection-item",i).removeClass("blur");if(c(this).val()!=""){s.css("width",i.outerWidth());h.show()}}return r=true}).blur(function(){if(c(this).val()==""&&j.val()==""&&e=="")c(this).val(a.startText);else if(r){c("li.as-selection-item",
i).addClass("blur").removeClass("selected");h.hide()}}).keydown(function(d){lastKeyPressCode=d.keyCode;first_focus=false;switch(d.keyCode){case 38:d.preventDefault();B("up");break;case 40:d.preventDefault();B("down");break;case 8:if(g.val()==""){d=j.val().split(",");d=d[d.length-2];i.children().not(o.prev()).removeClass("selected");if(o.prev().hasClass("selected")){j.val(j.val().replace(","+d+",",","));a.selectionRemoved.call(this,o.prev())}else{a.selectionClick.call(this,o.prev());o.prev().addClass("selected")}}if(g.val().length==
1){h.hide();w=""}if(c(":visible",h).length>0){t&&clearTimeout(t);t=setTimeout(function(){f()},a.keyDelay)}break;case 9:case 188:x=true;var b=g.val().replace(/(,)/g,"");if(b!=""&&j.val().search(","+b+",")<0&&b.length>=a.minChars){d.preventDefault();var e={};e[a.selectedItemProp]=b;e[a.selectedValuesProp]=b;b=c("li",i).length;y(e,"00"+(b+1));g.val("")}case 13:x=false;e=c("li.active:first",h);if(e.length>0){e.click();h.hide()}(a.neverSubmit||e.length>0)&&d.preventDefault();break;default:if(a.showResultList)if(a.selectionLimit&&
c("li.as-selection-item",i).length>=a.selectionLimit){s.html('<li class="as-message">'+a.limitText+"</li>");h.show()}else{t&&clearTimeout(t);t=setTimeout(function(){f()},a.keyDelay)}}});var A=0})}})(jQuery);