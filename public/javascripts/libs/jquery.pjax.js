// jquery.pjax.js
// copyright chris wanstrath
// https://github.com/defunkt/jquery-pjax

(function(c){function j(a,b,e){e=k(b,e);b=a.currentTarget;"A"!==b.tagName.toUpperCase()&&(b=c(b).find("a")[0]);if(!b)throw"$.fn.pjax or $.pjax.click requires an anchor element";if(!(1<a.which||a.metaKey))if(!(location.protocol!==b.protocol||location.host!==b.host)&&!(b.hash&&b.href.replace(b.hash,"")===location.href.replace(location.hash,"")))b={url:b.href,container:c(b).attr("data-pjax"),target:b,clickedElement:c(b),fragment:null},c.pjax(c.extend({},b,e)),a.preventDefault()}function k(a,b){a&&b?
b.container=a:b=c.isPlainObject(a)?a:{container:a};b.container&&(b.container=o(b.container));return b}function o(a){a=c(a);if(a.length){if(""!==a.selector&&a.context===document)return a;if(a.attr("id"))return c("#"+a.attr("id"));throw"cant get selector for pjax container!";}throw"no pjax container for "+a.selector;}function l(a,b){var e=c();a.each(function(){c(this).is(b)&&(e=e.add(this));e=e.add(b,this)});return e}function p(a,b,e){var d={},b=(b.getResponseHeader("X-PJAX-URL")||e.url).replace(/\?_pjax=[^&]+&?/,
"?").replace(/_pjax=[^&]+&?/,"").replace(/[\?&]$/,"");d.url=b;b=c(a);if(0===b.length)return d;d.title=l(b,"title").last().text();e.fragment?(a=l(b,e.fragment).first(),a.length&&(d.contents=a.contents(),d.title||(d.title=a.attr("title")||a.data("title")))):/<html/i.test(a)||(d.contents=b);d.contents&&(d.contents=d.contents.not("title"),d.contents.find("title").remove());d.title&&(d.title=c.trim(d.title));return d}function g(){this.mapping={};this.forwardStack=[];this.backStack=[]}c.fn.pjax=function(a,
b){return this.live("click.pjax",function(c){j(c,a,b)})};var f=c.pjax=function(a){function b(a,b){var d=c.Event(a,{relatedTarget:e});i.trigger(d,b);return!d.isDefaultPrevented()}a=c.extend(!0,{},c.ajaxSettings,f.defaults,a);c.isFunction(a.url)&&(a.url=a.url());var e=a.target;!e&&a.clickedElement&&(e=a.clickedElement[0]);var d=a.url,g=document.createElement("a");g.href=d;var q=g.hash,r=a.beforeSend,j=a.complete,k=a.success,l=a.error,i=a.context=o(a.container);a.data||(a.data={});a.data._pjax=i.selector;
var m;a.beforeSend=function(c,d){if(d.timeout>0){m=setTimeout(function(){b("pjax:timeout",[c,a])&&c.abort("timeout")},d.timeout);d.timeout=0}c.setRequestHeader("X-PJAX","true");c.setRequestHeader("X-PJAX-Container",i.selector);var e;if(r){e=r.apply(this,arguments);if(e===false)return false}if(!b("pjax:beforeSend",[c,d]))return false;if(a.push&&!a.replace){n.push(f.state.id,i.clone(true,true).contents());window.history.pushState(null,"",a.url)}b("pjax:start",[c,a]);b("start.pjax",[c,a]);b("pjax:send",
[c,d])};a.complete=function(c,d){m&&clearTimeout(m);j&&j.apply(this,arguments);b("pjax:complete",[c,d,a]);b("pjax:end",[c,a]);b("end.pjax",[c,a])};a.error=function(c,d,e){var f=p("",c,a);l&&l.apply(this,arguments);var g=b("pjax:error",[c,d,e,a]);if(d!=="abort"&&g)window.location=f.url};a.success=function(d,e,g){var h=p(d,g,a);if(h.contents){f.state={id:a.id||(new Date).getTime(),url:h.url,container:i.selector,fragment:a.fragment,timeout:a.timeout};(a.push||a.replace)&&window.history.replaceState(f.state,
h.title,h.url);if(h.title)document.title=h.title;i.html(h.contents);typeof a.scrollTo==="number"&&c(window).scrollTop(a.scrollTo);(a.replace||a.push)&&window._gaq&&_gaq.push(["_trackPageview"]);if(q!=="")window.location.href=q;k&&k.apply(this,arguments);b("pjax:success",[d,e,g,a])}else window.location=h.url};f.state||(f.state={id:(new Date).getTime(),url:window.location.href,container:i.selector,fragment:a.fragment,timeout:a.timeout},window.history.replaceState(f.state,document.title));if((d=f.xhr)&&
4>d.readyState)d.onreadystatechange=c.noop,d.abort();f.options=a;f.xhr=c.ajax(a);c(document).trigger("pjax",[f.xhr,a]);return f.xhr};f.reload=function(a,b){return c.pjax(c.extend({url:window.location.href,push:!1,replace:!0,scrollTo:!1},k(a,b)))};f.defaults={timeout:650,push:!0,replace:!1,type:"GET",dataType:"html",scrollTo:0,maxCacheLength:20};g.prototype.push=function(a,b){this.mapping[a]=b;for(this.backStack.push(a);this.forwardStack.length;)delete this.mapping[this.forwardStack.shift()];for(;this.backStack.length>
f.defaults.maxCacheLength;)delete this.mapping[this.backStack.shift()]};g.prototype.get=function(a){return this.mapping[a]};g.prototype.forward=function(a,b){this.mapping[a]=b;this.backStack.push(a);(a=this.forwardStack.pop())&&delete this.mapping[a]};g.prototype.back=function(a,b){this.mapping[a]=b;this.forwardStack.push(a);(a=this.backStack.pop())&&delete this.mapping[a]};var n=new g;f.click=j;var s="state"in window.history,t=location.href;c(window).bind("popstate",function(a){var b=!s&&location.href==
t;s=!0;if(!b&&(a=a.state)&&a.container)if(b=c(a.container),b.length){var e=n.get(a.id);if(f.state)n[f.state.id<a.id?"forward":"back"](f.state.id,b.clone(!0,!0).contents());var d={id:a.id,url:a.url,container:b,push:!1,fragment:a.fragment,timeout:a.timeout,scrollTo:!1};e?(c(document).trigger("pjax",[null,d]),b.trigger("pjax:start",[null,d]),b.trigger("start.pjax",[null,d]),b.html(e),f.state=a,b.trigger("pjax:end",[null,d]),b.trigger("end.pjax",[null,d])):c.pjax(d);b[0].offsetHeight}else window.location=
location.href});0>c.inArray("state",c.event.props)&&c.event.props.push("state");c.support.pjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);c.support.pjax||(c.pjax=function(a){var b=c.isFunction(a.url)?a.url():a.url,e=a.type?a.type.toUpperCase():"GET",d=c("<form>",{method:"GET"===e?"GET":"POST",action:b,style:"display:none"});"GET"!==e&&"POST"!==e&&d.append(c("<input>",{type:"hidden",name:"_method",
value:e.toLowerCase()}));a=a.data;if("string"===typeof a)c.each(a.split("&"),function(a,b){var e=b.split("=");d.append(c("<input>",{type:"hidden",name:e[0],value:e[1]}))});else if("object"===typeof a)for(key in a)d.append(c("<input>",{type:"hidden",name:key,value:a[key]}));c(document.body).append(d);d.submit()},c.pjax.click=c.noop,c.pjax.reload=window.location.reload,c.fn.pjax=function(){return this})})(jQuery);