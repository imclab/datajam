(function(t,e,j){var g=jQuery,k=window;e("datajam/init",[],function(){_.mixin({constantize:function(b,a){a||(a=k);var h=b.split(".");_.each(h,function(b){a=a[b]});return a},pathify:function(b,a){a||(a="");var h=b.split(/([A-Z]+|\.)/).slice(1);_.each(h,function(b){b.match(/[A-Z]+/)?(a.match(/[a-z]$/)&&(a+="_"),a+=b.toLowerCase()):a="."==b?a+"/":a+b});return a}});Backbone.emulateHTTP=!0;Backbone.emulateJSON=!0;Backbone.Model.prototype.idAttribute="_id";_.extend(Backbone.View.prototype,{initialize:function(){this.$el.data("view",
this);return this}});k.Datajam||(Datajam={});Datajam.models||(Datajam.models={});Datajam.views||(Datajam.views={});Datajam.collections||(Datajam.collections={});Datajam.templates||(Datajam.templates={});Datajam.modalRenderers||(Datajam.modalRenderers={});Datajam.settings||(Datajam.settings={debug:!0,interval:5E3});Datajam.csrf={csrf_param:g("meta[name=csrf-param]").attr("content"),csrf_token:g("meta[name=csrf-token]").attr("content")};g("document").bind("csrfloaded",function(){Datajam.csrf.csrf_token=
g("meta[name=csrf-token]").attr("content")})});var l=window.Datajam;e("datajam/models/event",["datajam/init"],function(){l.models.Event=Backbone.Model.extend({url:function(){return"/event/"+this.id+".json"},save:function(){l.debug("Datajam.models.event#save is not implemented.")},parse:function(b){b.content_areas&&b.content_areas.length&&(this.view.contentAreas.add(b.content_areas),delete b.content_areas);b.content_updates&&b.content_updates.length&&(this.view.contentUpdates.add(b.content_updates),
delete b.content_updates);return b},toJSON:function(b){b=Backbone.Model.prototype.toJSON.call(this,b);return _.extend(b,{content_areas:this.view.contentAreas.toJSON()})}})});var n=window.Datajam;e("datajam/models/content_area",["datajam/init"],function(){n.models.ContentArea=Backbone.Model.extend({})});var o=jQuery,m=window.Datajam;e("datajam/models/content_update",["datajam/init"],function(){m.models.ContentUpdate=Backbone.Model.extend({save:function(){return o.post("/onair/update.json",{event_id:m.event.model.id,
content_area_id:this.get("contentArea").id,html:this.get("html")})}})});var p=window.Datajam;e("datajam/collections/content_area",["datajam/init"],function(){p.collections.ContentArea=Backbone.Collection.extend({})});var q=window.Datajam;e("datajam/collections/content_update",["datajam/init"],function(){q.collections.ContentUpdate=Backbone.Collection.extend({initialize:function(){_.bindAll(this,"add","comparator","parse","url")},add:function(b,a){Backbone.Collection.prototype.add.call(this,b,a);b=
_.isArray(b)?b.slice():[b];_.each(b,_.bind(function(a){var b=this.view.contentAreas.get(a.content_area_id);"update"==a.action&&a.updated_at>b.get("updated_at")&&b.set({html:a.html,updated_at:a.updated_at})},this))},comparator:function(b,a){return b.get("updated_at")>a.get("updated_at")?-1:b.get("updated_at")<a.get("updated_at")?1:0},parse:function(b){return b.content_updates||[]},url:function(){return"/event/"+Datajam.event.model.id+"/updates.json"}})});var r=window.Datajam;e("datajam/views/content_area",
["datajam/init"],function(){r.views.ContentArea=Backbone.View.extend({initialize:function(){_.bindAll(this,"render");this.model.bind("change",this.render,this);return this},render:function(){this.$el.html(this.model.get("html"));return this}})});var f=window.Datajam;e("datajam/views/modal",["text!datajam/templates/modal.html","datajam/init","datajam/models/content_update"],function(b){f.views.Modal=Backbone.View.extend({events:{toggle:"toggle",hide:"hide","click .modal-update":"save","click .close":"hide",
keydown:"handleKeyDown"},templates:{},initialize:function(){_.bindAll(this,"handleKeyDown","hide","render","save","toggle");f.templates.modal||(f.templates.modal=Handlebars.compile(b));this.$el.data("modalView",this);this.model.bind("change",this.render,this);return this},handleKeyDown:function(a){if(13==a.keyCode&&(a.metaKey||a.ctrlKey))a.preventDefault(),a.stopPropagation(),this.save()},hide:function(a){try{a.preventDefault(),a.stopPropagation()}catch(b){}this.$el.modal("hide");return this},render:function(){var a=
this.template&&this.template()||f.templates.modal;this.$el.html(a(this.model.toJSON()));return this},save:function(a){try{a.preventDefault(),a.stopPropagation()}catch(b){}(new f.models.ContentUpdate({contentArea:this.model,html:this.$el.find("textarea").val()})).save().then(_.bind(function(){this.hide()},this)).fail(_.bind(function(){},this));return this},toggle:function(a){try{a.preventDefault(),a.stopPropagation()}catch(b){}a=this.$el.is(":visible");this.$el.modal("toggle");a||this.$el.find("input, select, textarea").eq(0).focus();
return this}})});var c=jQuery,i=window,d=i.Datajam;e("datajam/views/event","text!datajam/templates/onairtoolbar.html datajam/init datajam/collections/content_area datajam/collections/content_update datajam/models/event datajam/models/content_area datajam/models/content_update datajam/views/content_area datajam/views/modal".split(" "),function(b){d.views.Event=Backbone.View.extend({events:{"click a[data-controls-modal]":"handleToolbarItemClick"},templates:{},contentAreas:new d.collections.ContentArea,
contentUpdates:new d.collections.ContentUpdate,initialize:function(){_.bindAll(this,"authenticate","getSettings","handleKeyDown","handleToolbarItemClick","initializeAreas","initializeModals","initializeReminder","pollForUpdates","pollForAudience","renderToolbar","toggleModal");this.model=new d.models.Event({_id:d.eventId});this.model.view=this;this.contentAreas.view=this;this.contentUpdates.view=this;c(i).on("keydown.datajam",this.handleKeyDown);c.when(this.model.fetch(),this.getSettings()).then(_.bind(function(){this.authenticate();
this.initializeReminder();this.initializeAreas();this.pollForUpdates()},this));return this},authenticate:function(){return c.getJSON("/onair/signed_in.json",_.bind(function(a){if(a){if(a.csrfToken){c('meta[name="csrf-token"]').attr("content",a.csrfToken);c(document).trigger("csrfloaded")}if(a.signedIn===true){this.initializeModals();this.renderToolbar();this.pollForAudience()}}},this))},getSettings:function(){return c.getJSON("/settings.json",function(a){a&&a.length&&_.each(a,function(a){d.settings[a.name]=
a.value})})},handleKeyDown:function(a){if(a.keyCode>=49&&a.keyCode<=57&&a.ctrlKey)try{this.toggleModal("#modal-"+this.contentAreas.models[a.keyCode-49].id)}catch(b){}},handleToolbarItemClick:function(a){a.preventDefault();a.stopPropagation();this.toggleModal("#"+c(a.target).attr("data-controls-modal"));return this},initializeAreas:function(){_.each(this.contentAreas.models,_.bind(function(a,b,e){a.view=(new d.views.ContentArea({el:c("#"+a.get("area_type")+"_"+a.id),model:a,collection:e})).render()},
this));return this},initializeModals:function(){_.each(this.contentAreas.models,_.bind(function(a){var b=a.get("modal_class");j([_.pathify(b)],_.bind(function(){var d=_.constantize(b);a.modal=new d({el:c('<div id="modal-'+a.id+'" class="modal hide fade" style="display: none;">'),model:a});c("body").append(a.modal.el);a.modal.render();a.modal.$el.modal({backdrop:false,show:false})},this))},this));return this},initializeReminder:function(){var a=this.model.get("unix_scheduled_at"),b=(new Date).getTime()/
1E3;if(a>b){c("#event_reminder").show();c("#event_reminder form").on("ajax:success",function(a,b){c(this).find(".response").text(b.message).attr({"class":"alert alert-"+b.type}).fadeIn().delay(5E3).fadeOut();c(this).find("input[name=email]").val("")})}},pollForUpdates:function(){this.contentUpdates.fetch({add:true});setTimeout(_.bind(this.pollForUpdates,this),Datajam.settings.interval);return this},pollForAudience:function(){if(!d.settings.CHARTBEAT_API_KEY){this.$el.find("li.audience").hide();return this}c.ajax({url:"//api.chartbeat.com/live/quickstats/v3/",
dataType:"jsonp",jsonp:"jsonp",callback:"?",data:{apikey:d.settings.CHARTBEAT_API_KEY,host:location.hostname,path:location.pathname}}).then(_.bind(function(a){this.$el.find("li.audience .badge").html(a.people)},this));setTimeout(_.bind(this.pollForAudience,this),3E4);return this},remove:function(){c(i).off("keydown.datajam");BackboneView.prototype.remove.call(this)},renderToolbar:function(){d.templates.onairToolbar||(d.templates.onairToolbar=Handlebars.compile(b));this.$el.html(d.templates.onairToolbar(this.model.toJSON())).children().eq(0).addClass("topbarred");
return this},toggleModal:function(a){c("div.modal[id^=modal]").not("#"+a).trigger("hide");c(a).trigger("toggle");return this}})});var s=jQuery;j(["datajam/init","datajam/views/event"],function(){var b=s("body").prepend('<div class="datajam-event" />').find(".datajam-event");Datajam.event=new Datajam.views.Event({el:b})})})(jQuery,define,require);
