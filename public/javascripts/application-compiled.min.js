(function(u,e,h){var f=jQuery,j=window;e("datajam/init",[],function(){_.mixin({constantize:function(c,b){b||(b=j);var a=c.split(".");_.each(a,function(a){b=b[a]});return b},pathify:function(c,b){b||(b="");var a=c.split(/([A-Z]+|\.)/).slice(1);_.each(a,function(a){a.match(/[A-Z]+/)?(b.match(/[a-z]$/)&&(b+="_"),b+=a.toLowerCase()):b="."==a?b+"/":b+a});b.match(/^datajam\//)&&!b.match(/^datajam\/(views|models|collections|templates|init|libs)/)&&(b=b.replace("datajam/",""));return b}});Backbone.emulateHTTP=
!0;Backbone.emulateJSON=!0;Backbone.Model.prototype.idAttribute="_id";_.extend(Backbone.View.prototype,{initialize:function(){this.$el.data("view",this);return this}});j.Datajam||(Datajam={});Datajam.models||(Datajam.models={});Datajam.views||(Datajam.views={});Datajam.collections||(Datajam.collections={});Datajam.templates||(Datajam.templates={});Datajam.settings||(Datajam.settings={debug:!0,interval:5E3});Datajam.csrf={csrf_param:f("meta[name=csrf-param]").attr("content"),csrf_token:f("meta[name=csrf-token]").attr("content")};
f("document").bind("csrfloaded",function(){Datajam.csrf.csrf_token=f("meta[name=csrf-token]").attr("content")})});var k=window;e("datajam/models/event",["datajam/init"],function(){var c=k.Datajam;c.models.Event=Backbone.Model.extend({url:function(){return"/event/"+this.id+".json"},save:function(){c.debug("Datajam.models.event#save is not implemented.")},parse:function(b){b.content_areas&&b.content_areas.length&&(this.view.contentAreas.add(b.content_areas),delete b.content_areas);b.content_updates&&
b.content_updates.length&&(this.view.contentUpdates.add(b.content_updates),delete b.content_updates);return b},toJSON:function(b){b=Backbone.Model.prototype.toJSON.call(this,b);return _.extend(b,{content_areas:this.view.contentAreas.toJSON()})}})});var l=window;e("datajam/models/content_area",["datajam/init"],function(){l.Datajam.models.ContentArea=Backbone.Model.extend({})});var m=jQuery,n=window;e("datajam/models/content_update",["datajam/init"],function(){var c=n.Datajam;c.models.ContentUpdate=
Backbone.Model.extend({save:function(){return m.post("/onair/update.json",{event_id:c.event.model.id,content_area_id:this.get("contentArea").id,html:this.get("html")})}})});var p=window.Datajam;e("datajam/collections/content_area",["datajam/init"],function(){p.collections.ContentArea=Backbone.Collection.extend({})});var q=window.Datajam;e("datajam/collections/content_update",["datajam/init"],function(){q.collections.ContentUpdate=Backbone.Collection.extend({initialize:function(){_.bindAll(this,"add",
"comparator","parse","url")},add:function(c,b){Backbone.Collection.prototype.add.call(this,c,b);c=_.isArray(c)?c.slice():[c];_.each(c,_.bind(function(a){var b=this.view.contentAreas.get(a.content_area_id);b&&(a.updated_at>b.get("updated_at")||!b.get("updated_at"))&&b.set({html:a.html,updated_at:a.updated_at})},this))},comparator:function(c,b){return c.get("updated_at")>b.get("updated_at")?-1:c.get("updated_at")<b.get("updated_at")?1:0},parse:function(c){return c.content_updates||[]},url:function(){return"/event/"+
Datajam.event.model.id+"/updates.json"}})});var r=window;e("datajam/views/content_area",["datajam/init"],function(){r.Datajam.views.ContentArea=Backbone.View.extend({initialize:function(){_.bindAll(this,"render");this.model.bind("change",this.render,this);return this},render:function(){this.$el.html(this.model.get("html"));return this}})});var s=window;e("datajam/views/modal",["text!datajam/templates/modal.html","datajam/init","datajam/models/content_update"],function(c){var b=s.Datajam;b.views.Modal=
Backbone.View.extend({events:{toggle:"toggle",hide:"hide","click .modal-update":"save","click .close":"hide",keydown:"handleKeyDown"},templates:{},initialize:function(){_.bindAll(this,"handleKeyDown","hide","render","save","toggle");b.templates.modal||(b.templates.modal=Handlebars.compile(c));this.$el.data("modalView",this);this.model.bind("change",this.render,this);return this},handleKeyDown:function(a){if(13==a.keyCode&&(a.metaKey||a.ctrlKey))a.preventDefault(),a.stopPropagation(),this.save()},
hide:function(a){try{a.preventDefault(),a.stopPropagation()}catch(b){}this.$el.modal("hide");return this},render:function(){this.$el.html(("function"===typeof this.template&&this.template||b.templates.modal)(this.model.toJSON()));return this},save:function(a){try{a.preventDefault(),a.stopPropagation()}catch(c){}(new b.models.ContentUpdate({contentArea:this.model,html:this.$el.find("textarea").val()})).save().then(_.bind(function(){this.hide()},this)).fail(_.bind(function(){},this));return this},toggle:function(a){try{a.preventDefault(),
a.stopPropagation()}catch(b){}a=this.$el.is(":visible");this.$el.modal("toggle");a||this.$el.find("input, select, textarea").eq(0).focus();return this}})});var d=jQuery,g=window;e("datajam/views/event","text!datajam/templates/onairtoolbar.html datajam/init datajam/collections/content_area datajam/collections/content_update datajam/models/event datajam/models/content_area datajam/models/content_update datajam/views/content_area datajam/views/modal".split(" "),function(c){var b=g.Datajam;b.views.Event=
Backbone.View.extend({events:{"click a[data-controls-modal]":"handleToolbarItemClick"},templates:{},contentAreas:new b.collections.ContentArea,contentUpdates:new b.collections.ContentUpdate,initialize:function(){_.bindAll(this,"authenticate","getSettings","handleKeyDown","handleToolbarItemClick","initializeAreas","initializeModals","initializeReminder","pollForUpdates","pollForAudience","renderToolbar","toggleModal");this.model=new b.models.Event({_id:b.eventId});this.model.view=this;this.contentAreas.view=
this;this.contentUpdates.view=this;d(g).on("keydown.datajam",this.handleKeyDown);d.when(this.model.fetch(),this.getSettings()).then(_.bind(function(){this.authenticate();this.initializeReminder();this.initializeAreas();this.pollForUpdates()},this));return this},authenticate:function(){return d.getJSON("/onair/signed_in.json",_.bind(function(a){a&&(a.csrfToken&&(d('meta[name="csrf-token"]').attr("content",a.csrfToken),d(document).trigger("csrfloaded")),!0===a.signedIn&&(this.initializeModals(),this.renderToolbar(),
this.pollForAudience()))},this))},getSettings:function(){return d.getJSON("/settings.json",function(a){a&&a.length&&_.each(a,function(a){b.settings[a.name]=a.value})})},handleKeyDown:function(a){if(49<=a.keyCode&&57>=a.keyCode&&a.ctrlKey)try{this.toggleModal("#modal-"+this.contentAreas.models[a.keyCode-49].id)}catch(b){}},handleToolbarItemClick:function(a){a.preventDefault();a.stopPropagation();this.toggleModal("#"+d(a.target).attr("data-controls-modal"));return this},initializeAreas:function(){_.each(this.contentAreas.models,
_.bind(function(a,c,e){a.view=(new b.views.ContentArea({el:d("#"+a.get("area_type")+"_"+a.id),model:a,collection:e})).render()},this));return this},initializeModals:function(){_.each(this.contentAreas.models,_.bind(function(a){var b=a.get("modal_class");h([_.pathify(b)],_.bind(function(){var c=_.constantize(b);a.modal=new c({el:d('<div id="modal-'+a.id+'" class="modal hide fade" style="display: none;">'),model:a});d("body").append(a.modal.el);a.modal.render();a.modal.$el.modal({backdrop:!1,show:!1})},
this))},this));return this},initializeReminder:function(){var a=this.model.get("unix_scheduled_at"),b=(new Date).getTime()/1E3;a>b&&(d("#event_reminder").show(),d("#event_reminder form").on("ajax:success",function(b,a){d(this).find(".response").text(a.message).attr({"class":"response alert alert-"+a.type}).fadeIn().delay(5E3).fadeOut();d(this).find("input[name=email]").val("")}))},pollForUpdates:function(){this.contentUpdates.fetch({add:!0});setTimeout(_.bind(this.pollForUpdates,this),b.settings.interval);
return this},pollForAudience:function(){if(!b.settings.chartbeat_api_key)return this.$el.find("li.audience").hide(),this;d.ajax({url:"//api.chartbeat.com/live/quickstats/v3/",dataType:"jsonp",jsonp:"jsonp",callback:"?",data:{apikey:b.settings.chartbeat_api_key,host:location.hostname.replace(/^www\./,""),path:location.pathname}}).then(_.bind(function(a){this.$el.find("li.audience .badge").html(a.people)},this));setTimeout(_.bind(this.pollForAudience,this),3E4);return this},remove:function(){d(g).off("keydown.datajam");
BackboneView.prototype.remove.call(this)},renderToolbar:function(){b.templates.onairToolbar||(b.templates.onairToolbar=Handlebars.compile(c));this.$el.html(b.templates.onairToolbar(this.model.toJSON()));d("body").addClass("topbarred");return this},toggleModal:function(a){d("div.modal[id^=modal]").not("#"+a).trigger("hide");d(a).trigger("toggle");return this}})});var t=jQuery;h(["datajam/init","datajam/views/event"],function(){if(!Datajam.eventId)return!1;var c=t("body").prepend('<div class="datajam-event" />').find(".datajam-event");
Datajam.event=new Datajam.views.Event({el:c})})})(jQuery,define,require);
