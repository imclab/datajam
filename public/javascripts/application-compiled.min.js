(function(s,e,h){var f=jQuery,i=window;e("datajam/init",[],function(){_.mixin({constantize:function(c,a){a||(a=i);var b=c.split(".");_.each(b,function(b){a=a[b]});return a},pathify:function(c,a){a||(a="");var b=c.split(/([A-Z]+|\.)/).slice(1);_.each(b,function(b){b.match(/[A-Z]+/)?(a.match(/[a-z]$/)&&(a+="_"),a+=b.toLowerCase()):a="."==b?a+"/":a+b});a.match(/^datajam\//)&&!a.match(/^datajam\/(views|models|collections|templates|init|libs)/)&&(a=a.replace("datajam/",""));return a}});Backbone.emulateHTTP=
!0;Backbone.emulateJSON=!0;Backbone.Model.prototype.idAttribute="_id";_.extend(Backbone.View.prototype,{initialize:function(){this.$el.data("view",this);return this}});i.Datajam||(Datajam={});Datajam.models||(Datajam.models={});Datajam.views||(Datajam.views={});Datajam.collections||(Datajam.collections={});Datajam.templates||(Datajam.templates={});Datajam.settings||(Datajam.settings={debug:!0,interval:5E3});Datajam.csrf={csrf_param:f("meta[name=csrf-param]").attr("content"),csrf_token:f("meta[name=csrf-token]").attr("content")};
f("document").bind("csrfloaded",function(){Datajam.csrf.csrf_token=f("meta[name=csrf-token]").attr("content")})});var j=window;e("datajam/models/event",["datajam/init"],function(){var c=j.Datajam;c.models.Event=Backbone.Model.extend({url:function(){return"/event/"+this.id+".json"},save:function(){c.debug("Datajam.models.event#save is not implemented.")},parse:function(a){a.content_areas&&a.content_areas.length&&(this.view.contentAreas.add(a.content_areas),delete a.content_areas);a.content_updates&&
a.content_updates.length&&(this.view.contentUpdates.add(a.content_updates),delete a.content_updates);return a},toJSON:function(a){a=Backbone.Model.prototype.toJSON.call(this,a);return _.extend(a,{content_areas:this.view.contentAreas.toJSON()})}})});var k=window;e("datajam/models/content_area",["datajam/init"],function(){k.Datajam.models.ContentArea=Backbone.Model.extend({})});var l=jQuery,m=window;e("datajam/models/content_update",["datajam/init"],function(){var c=m.Datajam;c.models.ContentUpdate=
Backbone.Model.extend({save:function(){return l.post("/onair/update.json",{event_id:c.event.model.id,content_area_id:this.get("contentArea").id,html:this.get("html")})}})});var n=window.Datajam;e("datajam/collections/content_area",["datajam/init"],function(){n.collections.ContentArea=Backbone.Collection.extend({})});var o=window.Datajam;e("datajam/collections/content_update",["datajam/init"],function(){o.collections.ContentUpdate=Backbone.Collection.extend({initialize:function(){_.bindAll(this,"add",
"comparator","parse","url")},add:function(c,a){Backbone.Collection.prototype.add.call(this,c,a);c=_.isArray(c)?c.slice():[c];_.each(c,_.bind(function(b){var a=this.view.contentAreas.get(b.content_area_id);a&&b.updated_at>a.get("updated_at")&&a.set({html:b.html,updated_at:b.updated_at})},this))},comparator:function(c,a){return c.get("updated_at")>a.get("updated_at")?-1:c.get("updated_at")<a.get("updated_at")?1:0},parse:function(c){return c.content_updates||[]},url:function(){return"/event/"+Datajam.event.model.id+
"/updates.json"}})});var p=window;e("datajam/views/content_area",["datajam/init"],function(){p.Datajam.views.ContentArea=Backbone.View.extend({initialize:function(){_.bindAll(this,"render");this.model.bind("change",this.render,this);return this},render:function(){this.$el.html(this.model.get("html"));return this}})});var q=window;e("datajam/views/modal",["text!datajam/templates/modal.html","datajam/init","datajam/models/content_update"],function(c){var a=q.Datajam;a.views.Modal=Backbone.View.extend({events:{toggle:"toggle",
hide:"hide","click .modal-update":"save","click .close":"hide",keydown:"handleKeyDown"},templates:{},initialize:function(){_.bindAll(this,"handleKeyDown","hide","render","save","toggle");a.templates.modal||(a.templates.modal=Handlebars.compile(c));this.$el.data("modalView",this);this.model.bind("change",this.render,this);return this},handleKeyDown:function(b){if(13==b.keyCode&&(b.metaKey||b.ctrlKey))b.preventDefault(),b.stopPropagation(),this.save()},hide:function(b){try{b.preventDefault(),b.stopPropagation()}catch(a){}this.$el.modal("hide");
return this},render:function(){this.$el.html(("function"===typeof this.template&&this.template||a.templates.modal)(this.model.toJSON()));return this},save:function(b){try{b.preventDefault(),b.stopPropagation()}catch(c){}(new a.models.ContentUpdate({contentArea:this.model,html:this.$el.find("textarea").val()})).save().then(_.bind(function(){this.hide()},this)).fail(_.bind(function(){},this));return this},toggle:function(b){try{b.preventDefault(),b.stopPropagation()}catch(a){}b=this.$el.is(":visible");
this.$el.modal("toggle");b||this.$el.find("input, select, textarea").eq(0).focus();return this}})});var d=jQuery,g=window;e("datajam/views/event","text!datajam/templates/onairtoolbar.html datajam/init datajam/collections/content_area datajam/collections/content_update datajam/models/event datajam/models/content_area datajam/models/content_update datajam/views/content_area datajam/views/modal".split(" "),function(c){var a=g.Datajam;a.views.Event=Backbone.View.extend({events:{"click a[data-controls-modal]":"handleToolbarItemClick"},
templates:{},contentAreas:new a.collections.ContentArea,contentUpdates:new a.collections.ContentUpdate,initialize:function(){_.bindAll(this,"authenticate","getSettings","handleKeyDown","handleToolbarItemClick","initializeAreas","initializeModals","initializeReminder","pollForUpdates","pollForAudience","renderToolbar","toggleModal");this.model=new a.models.Event({_id:a.eventId});this.model.view=this;this.contentAreas.view=this;this.contentUpdates.view=this;d(g).on("keydown.datajam",this.handleKeyDown);
d.when(this.model.fetch(),this.getSettings()).then(_.bind(function(){this.authenticate();this.initializeReminder();this.initializeAreas();this.pollForUpdates()},this));return this},authenticate:function(){return d.getJSON("/onair/signed_in.json",_.bind(function(b){if(b){if(b.csrfToken){d('meta[name="csrf-token"]').attr("content",b.csrfToken);d(document).trigger("csrfloaded")}if(b.signedIn===true){this.initializeModals();this.renderToolbar();this.pollForAudience()}}},this))},getSettings:function(){return d.getJSON("/settings.json",
function(b){b&&b.length&&_.each(b,function(b){a.settings[b.name]=b.value})})},handleKeyDown:function(b){if(b.keyCode>=49&&b.keyCode<=57&&b.ctrlKey)try{this.toggleModal("#modal-"+this.contentAreas.models[b.keyCode-49].id)}catch(a){}},handleToolbarItemClick:function(b){b.preventDefault();b.stopPropagation();this.toggleModal("#"+d(b.target).attr("data-controls-modal"));return this},initializeAreas:function(){_.each(this.contentAreas.models,_.bind(function(b,c,e){b.view=(new a.views.ContentArea({el:d("#"+
b.get("area_type")+"_"+b.id),model:b,collection:e})).render()},this));return this},initializeModals:function(){_.each(this.contentAreas.models,_.bind(function(b){var a=b.get("modal_class");h([_.pathify(a)],_.bind(function(){var c=_.constantize(a);b.modal=new c({el:d('<div id="modal-'+b.id+'" class="modal hide fade" style="display: none;">'),model:b});d("body").append(b.modal.el);b.modal.render();b.modal.$el.modal({backdrop:false,show:false})},this))},this));return this},initializeReminder:function(){var b=
this.model.get("unix_scheduled_at"),a=(new Date).getTime()/1E3;if(b>a){d("#event_reminder").show();d("#event_reminder form").on("ajax:success",function(b,a){d(this).find(".response").text(a.message).attr({"class":"response alert alert-"+a.type}).fadeIn().delay(5E3).fadeOut();d(this).find("input[name=email]").val("")})}},pollForUpdates:function(){this.contentUpdates.fetch({add:true});setTimeout(_.bind(this.pollForUpdates,this),Datajam.settings.interval);return this},pollForAudience:function(){if(!a.settings.CHARTBEAT_API_KEY){this.$el.find("li.audience").hide();
return this}d.ajax({url:"//api.chartbeat.com/live/quickstats/v3/",dataType:"jsonp",jsonp:"jsonp",callback:"?",data:{apikey:a.settings.CHARTBEAT_API_KEY,host:location.hostname,path:location.pathname}}).then(_.bind(function(a){this.$el.find("li.audience .badge").html(a.people)},this));setTimeout(_.bind(this.pollForAudience,this),3E4);return this},remove:function(){d(g).off("keydown.datajam");BackboneView.prototype.remove.call(this)},renderToolbar:function(){a.templates.onairToolbar||(a.templates.onairToolbar=
Handlebars.compile(c));this.$el.html(a.templates.onairToolbar(this.model.toJSON()));d("body").addClass("topbarred");return this},toggleModal:function(a){d("div.modal[id^=modal]").not("#"+a).trigger("hide");d(a).trigger("toggle");return this}})});var r=jQuery;h(["datajam/init","datajam/views/event"],function(){var c=r("body").prepend('<div class="datajam-event" />').find(".datajam-event");Datajam.event=new Datajam.views.Event({el:c})})})(jQuery,define,require);
